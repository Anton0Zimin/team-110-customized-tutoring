<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <title>Team 110 Customized Tutoring</title>
</head>

<body>
    <main class="container">
        <h1 id="title">Team 110 Customized Tutoring</h1>

        <a id="loginLink">Log in</a>
        <button id="summarize">Summarize</button>

        <div class="grid">
            <div>
                <h2 id="summaryTitle">Full Section</h2>
                <div id="summary"></div>
            </div>
            <div>
                <h2 id="questionTitle"></h2>
                <div id="question"></div>
            </div>
        </div>
    </main>

    <script>
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");
        let accessCode = null;

        // Get the current authority (host + optional port)
        const authority = window.location.host;  // e.g. "localhost:8000"

        // Construct the redirect_uri using current protocol + authority
        const redirectUri = `${window.location.protocol}//${authority}`;

        // URL-encode redirect_uri
        const encodedRedirectUri = encodeURIComponent(redirectUri);

        // Build the login URL with the dynamic redirect_uri
        const loginUrl = `https://us-west-2zzdauxshh.auth.us-west-2.amazoncognito.com/login?client_id=7j8rf968khgtniemievdcs22lv&response_type=code&scope=email+openid+profile&redirect_uri=${encodedRedirectUri}`;

        document.getElementById('loginLink').href = loginUrl;

        if (code == null) {
            document.location = loginUrl;
        }
        else {
            getToken();
        }

        async function getToken() {
            try {
                const response = await fetch("/api/login/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ code })
                });

                const json = await response.json();

                if (response.ok) {
                    console.log("Server response:", json);
                    document.getElementById('title').innerText = 'Team 110 Customized Tutoring (' + json.name + ')';
                    accessCode = json.access_code;

                    loadSection();
                }
                else {
                    document.location = loginUrl;
                }
            }
            catch (error) {
                console.error("Fetch error:", error);
            }

        let divSummary = document.getElementById('summary');
        let divQuestion = document.getElementById('question');

        function loadSection() {
            fetch('/api/summary/full/1')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    divSummary.innerHTML = text.replace(/\n/g, '<br>');
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    divSummary.innerText = error;
                });

            document.getElementById('summarize').addEventListener('click', summarize);
        }

        function summarize() {
            divSummary.innerText = '⌛';
            divQuestion.innerText = '⌛';
            document.getElementById('summaryTitle').innerText = 'Summary';
            document.getElementById('questionTitle').innerText = 'Question';
            document.getElementById('summarize').disabled = true;

            fetch("/api/summary/short/1")
                .then(async response => {
                    if (!response.ok) {
                        const errorDetail = (await response.json()).detail;
                        throw new Error(`HTTP error! Status: ${response.status} ${errorDetail}`);
                    }
                    return response.json();
                })
                .then(data => {
                    divSummary.innerText = '';

                    for (row of data.summary) {
                        let text = document.createTextNode(row + ' ');
                        divSummary.appendChild(text);
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    divSummary.innerText = error;
                });

            fetch("/api/questions/1")
                .then(async response => {
                    if (!response.ok) {
                        const errorDetail = (await response.json()).detail;
                        throw new Error(`HTTP error! Status: ${response.status} ${errorDetail}`);
                    }
                    return response.json();
                })
                .then(data => {
                    divQuestion.innerText = '';

                    let questionIndex = 0;
                    let radioIndex = 0;

                    for (item of data.questions) {
                        const p = document.createElement('p');
                        p.innerText = item.question;
                        divQuestion.appendChild(p);

                        for (answer of item.answers) {
                            const div = document.createElement('div');

                            const radio = document.createElement('input');
                            radio.name = 'radioQuestion' + questionIndex;
                            radio.id = 'radio' + radioIndex;
                            radio.type = 'radio';
                            div.appendChild(radio);

                            const label = document.createElement('label');
                            label.htmlFor = radio.id;
                            label.innerText = answer.text;
                            div.appendChild(label);

                            divQuestion.appendChild(div);
                            radioIndex++;
                        }

                        const p2 = document.createElement('p');
                        p2.innerHTML = '&nbsp;';
                        divQuestion.appendChild(p2);
                        questionIndex++;
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    divQuestion.innerText = error;
                });
            }
        }
    </script>
</body>

</html>